// Kiwi's Tech Tree Overhaul (Structural Parts Stock Upgrades)
// Version 2.0
// Created: 26 August 2020 for KSP 1.9.1 to 1.10.1
// Last Updated: 25 April 2022 for KSP 1.12.3
// 28 September 2020: Added a template for Even Later Tier9+ Structural Upgrades which was otherwise only used for Near Future Space Craft and Launch Vehicles as a just in case.
// 21 October 2020: Added a Coatl Aerospace Structural part as too lazy to add a new config just for that.
// 26 October 2020: Changed KiwiAerospace to KiwiTechTree
// 27 October 2020: Added support for general upgrades via declaring a variable
// 1 November 2020: Further generalized the structural upgrade code
// 2 November 2020: Added patch to identify the location of the upgrade found in the description!
// 11 November 2020: Removed legacy structural part upgrades
// 23 November 2020: Added toggle for structural parts upgrades
// 12 December 2020: Made it easier to identify the name of structural upgrades. 
// 25 April 2022: Simplified the upgrade to no longer be tier specific and aggregated structrual, system, and tank upgrades into a single upgrade.

// Structural Pieces
@PART[*]:HAS[#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:FOR[zzKiwiTechTree]
{
	//Dry Mass
	%dryMass = #$mass$
	@dryMass *= -1
	%costAdjust = #$cost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[LiquidFuel],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[LiquidFuel]/unitCost$
	@liqCost *= #$RESOURCE[LiquidFuel]/maxAmount$
	@liqCost *= -1
	@costAdjust += #$liqCost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[Oxidizer],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	@liqCost *= #$RESOURCE[Oxidizer]/maxAmount$
	@liqCost *= -1	
	@costAdjust += #$liqCost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[Lithium],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[Lithium]/unitCost$
	@liqCost *= #$RESOURCE[Lithium]/maxAmount$
	@liqCost *= -1	
	@costAdjust += #$liqCost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[XenonGas],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[XenonGas]/unitCost$
	@liqCost *= #$RESOURCE[XenonGas]/maxAmount$
	@liqCost *= -1	
	@costAdjust += #$liqCost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[ArgonGas],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[ArgonGas]/unitCost$
	@liqCost *= #$RESOURCE[ArgonGas]/maxAmount$
	@liqCost *= -1	
	@costAdjust += #$liqCost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[MonoPropellant],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[MonoPropellant]/unitCost$
	@liqCost *= #$RESOURCE[MonoPropellant]/maxAmount$
	@liqCost *= -1	
	@costAdjust += #$liqCost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[Ore],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[Ore]/unitCost$
	@liqCost *= #$RESOURCE[Ore]/maxAmount$
	@liqCost *= -1	
	@costAdjust += #$liqCost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[Metals],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[Metals]/unitCost$
	@liqCost *= #$RESOURCE[Metals]/maxAmount$
	@liqCost *= -1	
	@costAdjust += #$liqCost$
}
@PART[*]:HAS[@MODULE[ModuleEngines*],@RESOURCE[SolidFuel],#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
	%liqCost = #$@RESOURCE_DEFINITION[SolidFuel]/unitCost$
	@liqCost *= #$RESOURCE[SolidFuel]/maxAmount$
	@liqCost *= -1	
	@costAdjust += #$liqCost$
}

@PART[*]:HAS[#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true],!MODULE[ModuleB9PartSwitch]:HAS[#moduleID[kiwiStructuralSwitch]]]:NEEDS[!CryoTanks]:AFTER[zzKiwiTechTree]
{
	%addCost_0 = #$costAdjust$
	@addCost_0 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL0/UPGRADE_COST_MULTIPLIER$
	%addMass_0 = #$dryMass$
	@addMass_0 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL0/UPGRADE_MASS_MULTIPLIER$
	
	%addCost_1 = #$costAdjust$
	@addCost_1 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL1/UPGRADE_COST_MULTIPLIER$
	%addMass_1 = #$dryMass$
	@addMass_1 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL1/UPGRADE_MASS_MULTIPLIER$
	
	%addCost_2 = #$costAdjust$
	@addCost_2 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL2/UPGRADE_COST_MULTIPLIER$
	%addMass_2 = #$dryMass$
	@addMass_2 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL2/UPGRADE_MASS_MULTIPLIER$
	
	%addCost_3 = #$costAdjust$
	@addCost_3 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL3/UPGRADE_COST_MULTIPLIER$
	%addMass_3 = #$dryMass$
	@addMass_3 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL3/UPGRADE_MASS_MULTIPLIER$
	
	%addCost_4 = #$costAdjust$
	@addCost_4 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL4/UPGRADE_COST_MULTIPLIER$
	%addMass_4 = #$dryMass$
	@addMass_4 *= #$@KIWI_STRUCTURAL_MULTIPLIERS/LEVEL4/UPGRADE_MASS_MULTIPLIER$
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = kiwiStructuralSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_STRUCTURALSWITCH
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_STRUCTURALSWITCH
		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
		{
			name = Level0
			title = #LOC_KTT_B9DESCRIPTION_STRUCTURAL_LEVEL0_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Reduced Mass:</b> $../../addMass_0$%
			primaryColor = #fdb777
			secondaryColor = #fdb777
			addedCost = #$../../addCost_0$
			addedMass = #$../../addMass_0$
			
			defaultSubtypePriority = 1
		}
		SUBTYPE
		{
			name = Level1
			title = #LOC_KTT_B9DESCRIPTION_STRUCTURAL_LEVEL1_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Reduced Mass:</b> $../../addMass_1$%
			primaryColor = #fda766
			secondaryColor = #fda766
			addedCost = #$../../addCost_1$
			addedMass = #$../../addMass_1$
			upgradeRequired = level1Structural
		}
		SUBTYPE
		{
			name = Level2
			title = #LOC_KTT_B9DESCRIPTION_STRUCTURAL_LEVEL2_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Reduced Mass:</b> $../../addMass_2$%
			primaryColor = #fd9346
			secondaryColor = #fd9346
			addedCost = #$../../addCost_2$
			addedMass = #$../../addMass_2$
			upgradeRequired = level2Structural
		}
		SUBTYPE
		{
			name = Level3
			title = #LOC_KTT_B9DESCRIPTION_STRUCTURAL_LEVEL3_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Reduced Mass:</b> $../../addMass_3$%
			primaryColor = #fd7f2c
			secondaryColor = #fd7f2c
			addedCost = #$../../addCost_3$
			addedMass = #$../../addMass_3$
			upgradeRequired = level3Structural
		}
		SUBTYPE
		{
			name = Level4
			title = #LOC_KTT_B9DESCRIPTION_STRUCTURAL_LEVEL4_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Reduced Mass:</b> $../../addMass_4$%
			primaryColor = #ff6200
			secondaryColor = #ff6200
			addedCost = #$../../addCost_4$
			addedMass = #$../../addMass_4$
			upgradeRequired = level4Structural
		}
	}
}

PARTUPGRADE:NEEDS[Squad]
{
    type = structural
    name = level1Structural
    partIcon = winglet
    techRequired = advConstruction
    entryCost = 250000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_STRUCTURAL_LEVEL1
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_STRUCTURAL
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_STRUCTURAL
}
PARTUPGRADE:NEEDS[Squad]
{
    type = structural
    name = level2Structural
    partIcon = winglet
    techRequired = composites
    entryCost = 500000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_STRUCTURAL_LEVEL2
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_STRUCTURAL
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_STRUCTURAL
}
PARTUPGRADE:NEEDS[Squad]
{
    type = engine
    name = level3Structural
    partIcon = winglet
    techRequired = exoticAlloys
    entryCost = 1000000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_STRUCTURAL_LEVEL3
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_STRUCTURAL
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_STRUCTURAL
}
PARTUPGRADE:NEEDS[Squad]
{
    type = engine
    name = level4Structural
    partIcon = winglet
    techRequired = bioActivatedAerographite
    entryCost = 2000000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_STRUCTURAL_LEVEL4
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_STRUCTURAL
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_STRUCTURAL
}

@PART[*]:HAS[#kiwiStructuralUpgrade[standard],~structuralUpgrade[off],~fuelSwitchIgnore[true]]:FOR[zzzKiwiTechTree]
{
    %descriptionUpgrade = #LOC_KTT_PART_DESCRIPTION_STRUCTURAL
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= :UPGRADENODE1:Advanced Construction (Tier 5):
	@description ^= :UPGRADENODE2:Composites (Tier 7):
	@description ^= :UPGRADENODE3:Exotic Alloys (Tier 9):
	@description ^= :UPGRADENODE4:Bio-Activated Aerographite (Tier 11):
}
