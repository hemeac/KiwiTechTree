// Kiwi's Tech Tree Overhaul (Standardized Engine Upgrades)
// Version 2.0
// Created: 27 October 2020 for KSP 1.11.1
// Last Updated: 1 January 2021
// Special Thanks to JadeofMaar and Kerbalism team, these configs would not be possible without your excellent work!


// Standard Single Fuel Engine Prototype
@PART[*]:HAS[#kiwiEngineUpgrade[singleMode],~engineUpgrade[off]]:BEFORE[zzKiwiTechTree]
{	
	kerbalismReliability = true
	thrustMult = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,1[1, ]$ // get ASL Isp number
	@thrustMult /= #$MODULE[ModuleEngines*],0/atmosphereCurve/key,0[1, ]$ // get vac Isp number
	
	// Add these here without % or @ so they can be manually overriden by individual parts if required as MM should grab the first instance 
	prototypeThrustMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/PROTOTYPE_THRUST_MULTIPLIER$
	prototypeISPMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/PROTOTYPE_ISP_MULTIPLIER$
	prototypeCostMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/PROTOTYPE_COST_MULTIPLIER$
	prototypeMassMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/PROTOTYPE_MASS_MULTIPLIER$
	
	
	%addCost_P = #$cost$
	@addCost_P *= #$prototypeCostMultiplierConfig$
	
	%addMass_P = #$mass$
	@addMass_P *= #$prototypeMassMultiplierConfig$
	
	// Storing the baseline thrust as well
	prototypeThrust_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@prototypeThrust_0 *= #$prototypeThrustMultiplierConfig$
		
	key0_P_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,0$
	@key0_P_0[1, ] *= #$prototypeISPMultiplierConfig$
	key1_P_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,1$
	@key1_P_0[1, ] *= #$prototypeISPMultiplierConfig$
	key2_P_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,2$
	@key2_P_0[1, ] *= #$prototypeISPMultiplierConfig$
	
	ispVac_P_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,0[1, ]$ // get vac Isp number
	@ispVac_P_0 *= #$prototypeISPMultiplierConfig$
	@ispVac_P_0 *= 10
	@ispVac_P_0 ^= :\.\d+:: // Floor value to get an integer
	@ispVac_P_0 /= 10
	
	ispASL_P_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,1[1, ]$ // get ASL Isp number
	@ispASL_P_0 *= #$prototypeISPMultiplierConfig$
	@ispASL_P_0 *= 10
	@ispASL_P_0 ^= :\.\d+:: // Floor value to get an integer
	@ispASL_P_0 /= 10
	
	thrustVac_P_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@thrustVac_P_0 *= #$prototypeThrustMultiplierConfig$
	@thrustVac_P_0 *= 10
	@thrustVac_P_0 ^= :\.\d+:: // Floor value to get an integer
	@thrustVac_P_0 /= 10
	
	thrustASL_P_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@thrustASL_P_0 *= #$prototypeThrustMultiplierConfig$
	@thrustASL_P_0 *= #$thrustMult$
	@thrustASL_P_0 *= 10
	@thrustASL_P_0 ^= :\.\d+:: // Floor value to get an integer
	@thrustASL_P_0 /= 10
	
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = kiwiEngineSwitch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_ENGINESWITCH
		switcherDescription = #LOC_KTT_B9DESCRIPTION_ENGINESWITCH

		affectDragCubes = False
		affectFARVoxels = False
		
		SUBTYPE
	    {
			name = prototype
			title = #LOC_KTT_B9TITLE_PROTOTYPE
			descriptionDetail = #<b>Thrust:</b> $../../thrustASL_P_0$ kN ASL / $../../thrustVac_P_0$ kN Vac.\n<b>Isp:</b> $../../ispASL_P_0$ s ASL / $../../ispVac_P_0$ s Vac.
			addedCost = #$../../addCost_P$
			addedMass = #$../../addMass_P$
			defaultSubtypePriority = 0
			primaryColor = #38FF38
			secondaryColor = #38FF38

			MODULE
			{
			    IDENTIFIER
			    {
					name = ModuleEngines*
			    }

			    DATA
			    {
					maxThrust = #$../../../../prototypeThrust_0$
					atmosphereCurve
					{
						key = #$../../../../../key0_P_0$
						key = #$../../../../../key1_P_0$
						key = #$../../../../../key2_P_0$
					}
				}			    
			}
	    }
	}	
}

// Standard Single Fuel Engine Upgrade
@PART[*]:HAS[#kiwiEngineUpgrade[singleMode],~engineUpgrade[off]]:FOR[zzKiwiTechTree]
{	
	//// **** BASELINE **** \\\\
	// Add these here without % or @ so they can be manually overriden by individual parts if required as MM should grab the first instance 
	baselineThrustMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/BASELINE_THRUST_MULTIPLIER$
	baselineISPMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/BASELINE_ISP_MULTIPLIER$
		
	%addCost_B = 0
	
	%addMass_B = 0
	
	// Storing the baseline thrust as well
	baselineThrust_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@baselineThrust_0 *= #$baselineThrustMultiplierConfig$
		
	%key0_B_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,0$
	@key0_B_0[1, ] *= #$baselineISPMultiplierConfig$
	%key1_B_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,1$
	@key1_B_0[1, ] *= #$baselineISPMultiplierConfig$
	%key2_B_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,2$
	@key2_B_0[1, ] *= #$baselineISPMultiplierConfig$
	
	%ispVac_B_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,0[1, ]$ // get vac Isp number
	@ispVac_B_0 *= #$baselineKeroloxISPMultiplierConfig$
	@ispVac_B_0 *= 10
	@ispVac_B_0 ^= :\.\d+:: // Floor value to get an integer
	@ispVac_B_0 /= 10
	
	%ispASL_B_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,1[1, ]$ // get ASL Isp number
	@ispASL_B_0 *= #$baselineKeroloxISPMultiplierConfig$
	@ispASL_B_0 *= 10
	@ispASL_B_0 ^= :\.\d+:: // Floor value to get an integer
	@ispASL_B_0 /= 10
		
	%thrustVac_B_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@thrustVac_B_0 *= #$baselineKeroloxThrustMultiplierConfig$
	@thrustVac_B_0 *= 10
	@thrustVac_B_0 ^= :\.\d+:: // Floor value to get an integer
	@thrustVac_B_0 /= 10
	
	%thrustASL_B_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@thrustASL_B_0 *= #$baselineKeroloxThrustMultiplierConfig$
	@thrustASL_B_0 *= #$thrustMult$
	@thrustASL_B_0 *= 10
	@thrustASL_B_0 ^= :\.\d+:: // Floor value to get an integer
	@thrustASL_B_0 /= 10
	
	
	//// **** UPGRADE **** \\\\
	upgradeThrustMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/UPGRADE_THRUST_MULTIPLIER$
	upgradeISPMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/UPGRADE_ISP_MULTIPLIER$
	upgradeCostMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/UPGRADE_COST_MULTIPLIER$
	upgradeMassMultiplierConfig = #$@KIWI_ENGINE_MULTIPLIERS/UPGRADE_MASS_MULTIPLIER$
	
	%addCost_U = #$cost$
	@addCost_U *= #$upgradeCostMultiplierConfig$
	
	%addMass_U = #$mass$
	@addMass_U *= #$upgradeMassMultiplierConfig$
	
	// Storing the upgrade thrust as well
	upgradeThrust_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@upgradeThrust_0 *= #$upgradeKeroloxThrustMultiplierConfig$
		
	%key0_U_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,0$
	@key0_U_0[1, ] *= #$upgradeISPMultiplierConfig$
	%key1_U_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,1$
	@key1_U_0[1, ] *= #$upgradeISPMultiplierConfig$
	%key2_U_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,2$
	@key2_U_0[1, ] *= #$upgradeISPMultiplierConfig$
	
	%ispVac_U_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,0[1, ]$ // get vac Isp number
	@ispVac_U_0 *= #$upgradeISPMultiplierConfig$
	@ispVac_U_0 *= 10
	@ispVac_U_0 ^= :\.\d+:: // Floor value to get an integer
	@ispVac_U_0 /= 10
	
	%ispASL_U_0 = #$MODULE[ModuleEngines*],0/atmosphereCurve/key,1[1, ]$ // get ASL Isp number
	@ispASL_U_0 *= #$upgradeISPMultiplierConfig$
	@ispASL_U_0 *= 10
	@ispASL_U_0 ^= :\.\d+:: // Floor value to get an integer
	@ispASL_U_0 /= 10
	
	%thrustVac_U_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@thrustVac_U_0 *= #$upgradeThrustMultiplierConfig$
	@thrustVac_U_0 *= 10
	@thrustVac_U_0 ^= :\.\d+:: // Floor value to get an integer
	@thrustVac_U_0 /= 10
	
	%thrustASL_U_0 = #$MODULE[ModuleEngines*],0/maxThrust$
	@thrustASL_U_0 *= #$upgradeThrustMultiplierConfig$
	@thrustASL_U_0 *= #$thrustMult$
	@thrustASL_U_0 *= 10
	@thrustASL_U_0 ^= :\.\d+:: // Floor value to get an integer
	@thrustASL_U_0 /= 10
	
	
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[kiwiEngineSwitch]]
	{
		SUBTYPE
	    {
			name = baseline
			title = #LOC_KTT_B9TITLE_BASELINE
			descriptionDetail = #<b>Thrust:</b> $../../thrustASL_B_0$ kN ASL / $../../thrustVac_B_0$ kN Vac.\n<b>Isp:</b> $../../ispASL_B_0$ s ASL / $../../ispVac_B_0$ s Vac.
			addedCost = #$../../addCost_B$
			addedMass = #$../../addMass_B$
			defaultSubtypePriority = 1
			primaryColor = #00C60D
			secondaryColor = #00C60D
			upgradeRequired = #$../../kiwiEngineUpgrade0$
			MODULE
			{
			    IDENTIFIER
			    {
					name = ModuleEngines*
			    }

			    DATA
			    {
					maxThrust = #$../../../../baselineThrust_0$
					atmosphereCurve
					{
						key = #$../../../../../key0_B_0$
						key = #$../../../../../key1_B_0$
						key = #$../../../../../key2_B_0$
					}
				}			    
			}
	    }
		
		SUBTYPE
	    {
			name = upgrade
			title = #LOC_KTT_B9TITLE_UPGRADE
			descriptionDetail = #<b>Thrust:</b> $../../thrustASL_U_0$ kN ASL / $../../thrustVac_U_0$ kN Vac.\n<b>Isp:</b> $../../ispASL_U_0$ s ASL / $../../ispVac_U_0$ s Vac.
			addedCost = #$../../addCost_U$
			addedMass = #$../../addMass_U$
			defaultSubtypePriority = 0
			primaryColor = #005528
			secondaryColor = #005528
			upgradeRequired = #$../../kiwiEngineUpgrade1$
			MODULE
			{
			    IDENTIFIER
			    {
					name = ModuleEngines*
			    }

			    DATA
			    {
					maxThrust = #$../../../../upgradeThrust_0$
					atmosphereCurve
					{
						key = #$../../../../../key0_U_0$
						key = #$../../../../../key1_U_0$
						key = #$../../../../../key2_U_0$
					}
				}			    
			}
	    }
	}	
}
