// Kiwi's Tech Tree Overhaul (Solar Panel Upgrades)
// Version 2.0
// Created: 3 November 2020 for KSP 1.9.1 to 1.10.1
// Last Updated: 4 January 2021 for KSP 1.11.1
// 23 November 2020: Added switch to disable solar upgrades
// 3 January 2021: Updated for new upgrade system; removed NF Solar as a requirement.

@PART[*]:HAS[#kiwiSolarUpgrade[standard],~solarUpgrade[off],@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[cellSwitch]]]:FOR[zzKiwiTechTree]
{
	@MODULE[Module*SolarPanel]
	{
		@chargeRate *= 0.78
	}
	
	// Duplicate the Advanced Switch for panels that do not have the concentrating subtype
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[cellSwitch],!SUBTYPE[Concentrating]]
	{
		+SUBTYPE[Advanced]
		{
			@name = Concentrating
		}
	}
}

@PART[*]:HAS[#kiwiSolarUpgrade[standard],~solarUpgrade[off],@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[cellSwitch]]]:FOR[zzKiwiTechTree]
{
	%addCost_0 = #$cost$
	@addCost_0 *= #$@KIWI_SOLAR_MULTIPLIERS/BASIC/UPGRADE_COST_MULTIPLIER$
	%addMass_0 = #$mass$
	@addMass_0 *= #$@KIWI_SOLAR_MULTIPLIERS/BASIC/UPGRADE_MASS_MULTIPLIER$
	%chargeRate_0_Multiplier = #$@KIWI_SOLAR_MULTIPLIERS/BASIC/UPGRADE_CHARGERATE_MULTIPLIER$
	
	%addCost_1 = #$cost$
	@addCost_1 *= #$@KIWI_SOLAR_MULTIPLIERS/ADVANCED/UPGRADE_COST_MULTIPLIER$
	%addMass_1 = #$mass$
	@addMass_1 *= #$@KIWI_SOLAR_MULTIPLIERS/ADVANCED/UPGRADE_MASS_MULTIPLIER$
	%chargeRate_1_Multiplier = #$@KIWI_SOLAR_MULTIPLIERS/ADVANCED/UPGRADE_CHARGERATE_MULTIPLIER$
	
	%addCost_2 = #$cost$
	@addCost_2 *= #$@KIWI_SOLAR_MULTIPLIERS/CONCENTRATING/UPGRADE_COST_MULTIPLIER$
	%addMass_2 = #$mass$
	@addMass_2 *= #$@KIWI_SOLAR_MULTIPLIERS/CONCENTRATING/UPGRADE_MASS_MULTIPLIER$
	%chargeRate_2_Multiplier = #$@KIWI_SOLAR_MULTIPLIERS/CONCENTRATING/UPGRADE_CHARGERATE_MULTIPLIER$
	
	%addCost_3 = #$cost$
	@addCost_3 *= #$@KIWI_SOLAR_MULTIPLIERS/EXPERIMENTAL/UPGRADE_COST_MULTIPLIER$
	%addMass_3 = #$mass$
	@addMass_3 *= #$@KIWI_SOLAR_MULTIPLIERS/EXPERIMENTAL/UPGRADE_MASS_MULTIPLIER$
	%chargeRate_3_Multiplier = #$@KIWI_SOLAR_MULTIPLIERS/EXPERIMENTAL/UPGRADE_CHARGERATE_MULTIPLIER$
	
	%baseChargeRate = #$MODULE[Module*SolarPanel],0/chargeRate$
	chargeRate_0 = #$baseChargeRate$
	@chargeRate_0 *= #$chargeRate_0_Multiplier$
	chargeRate_1 = #$baseChargeRate$
	@chargeRate_1 *= #$chargeRate_1_Multiplier$
	chargeRate_2 = #$baseChargeRate$
	@chargeRate_2 *= #$chargeRate_2_Multiplier$
	chargeRate_3 = #$baseChargeRate$
	@chargeRate_3 *= #$chargeRate_3_Multiplier$
	
	chargeRate_0_Description = #$chargeRate_0$
	@chargeRate_0_Description *= 10
	@chargeRate_0_Description ^= :\.\d+:: // Floor value to get an integer
	@chargeRate_0_Description /= 10
	
	chargeRate_1_Description = #$chargeRate_1$
	@chargeRate_1_Description *= 10
	@chargeRate_1_Description ^= :\.\d+:: // Floor value to get an integer
	@chargeRate_1_Description /= 10
	
	chargeRate_2_Description = #$chargeRate_2$
	@chargeRate_2_Description *= 10
	@chargeRate_2_Description ^= :\.\d+:: // Floor value to get an integer
	@chargeRate_2_Description /= 10
	
	chargeRate_3_Description = #$chargeRate_3$
	@chargeRate_3_Description *= 10
	@chargeRate_3_Description ^= :\.\d+:: // Floor value to get an integer
	@chargeRate_3_Description /= 10
	
	@MODULE[ModuleDeployableSolarPanel],*
	{
		!UPGRADES {} // No use having multple upgrades
	}
	
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[cellSwitch]]
	{
		@switcherDescription = #LOC_KTT_B9DESCRIPTION_CELLSWITCH // Cell Switch
		@switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_CELLSWITCH //Cell Types

		@SUBTYPE[Basic]
		{
			@title = #LOC_KTT_B9DESCRIPTION_SOLAR_BASIC_TITLE
			@descriptionSummary = 
			@descriptionDetail = #<b>Electric Charge:</b> $../../chargeRate_0_Description$/sec
			@primaryColor = #aebac0
			@secondaryColor = #aebac0
			@addedCost = #$../../addCost_0$
			@addedMass = #$../../addMass_0$
			%defaultSubtypePriority = 1
			
			@MODULE
			{
				@DATA 
				{
					@chargeRate = #$../../../../chargeRate_0$
				}
			}
		}
		
		@SUBTYPE[Advanced]
		{
			@title = #LOC_KTT_B9DESCRIPTION_SOLAR_ADVANCED_TITLE
			@descriptionSummary = 
			@descriptionDetail = #<b>Electric Charge:</b> $../../chargeRate_1_Description$/sec
			@primaryColor = #5d7682
			@secondaryColor = #5d7682
			%upgradeRequired = advancedSolarCell
			@addedCost = #$../../addCost_1$
			@addedMass = #$../../addMass_1$
			%defaultSubtypePriority = 0
			
			@MODULE
			{
				@DATA 
				{
					@chargeRate = #$../../../../chargeRate_1$
				}
			}
		}
		
		@SUBTYPE[Concentrating]
		{
			@title = #LOC_KTT_B9DESCRIPTION_SOLAR_CONCENTRATING_TITLE
			@descriptionSummary = 
			@descriptionDetail = #<b>Electric Charge:</b> $../../chargeRate_2_Description$/sec
			@primaryColor = #2d373c
			@secondaryColor = #2d373c
			%upgradeRequired = concentratingSolarCell
			@addedCost = #$../../addCost_2$
			@addedMass = #$../../addMass_2$
			%defaultSubtypePriority = 0

			@MODULE
			{
				@DATA 
				{
					@chargeRate = #$../../../../chargeRate_2$
				}
			}
		}
		
		+SUBTYPE[Concentrating]
		{
			@name = Experimental
			@title = #LOC_KTT_B9DESCRIPTION_SOLAR_EXPERIMENTAL_TITLE
			@descriptionSummary = 
			@descriptionDetail = #<b>Electric Charge:</b> $../../chargeRate_3_Description$/sec
			@primaryColor = #000000
			@secondaryColor = #000000
			%upgradeRequired = experimentalSolarCell
			@addedCost = #$../../addCost_3$
			@addedMass = #$../../addMass_3$
			%defaultSubtypePriority = 0

			@MODULE
			{
				@DATA 
				{
					@chargeRate = #$../../../../chargeRate_3$
				}
			}
		}
	}
}

@PART[*]:HAS[#kiwiSolarUpgrade[standard],~solarUpgrade[off],!MODULE[ModuleB9PartSwitch]:HAS[#moduleID[cellSwitch]]]:FOR[zzKiwiTechTree]
{
	%addCost_0 = #$cost$
	@addCost_0 *= #$@KIWI_SOLAR_MULTIPLIERS/BASIC/UPGRADE_COST_MULTIPLIER$
	%addMass_0 = #$mass$
	@addMass_0 *= #$@KIWI_SOLAR_MULTIPLIERS/BASIC/UPGRADE_MASS_MULTIPLIER$
	%chargeRate_0_Multiplier = #$@KIWI_SOLAR_MULTIPLIERS/BASIC/UPGRADE_CHARGERATE_MULTIPLIER$
	
	%addCost_1 = #$cost$
	@addCost_1 *= #$@KIWI_SOLAR_MULTIPLIERS/ADVANCED/UPGRADE_COST_MULTIPLIER$
	%addMass_1 = #$mass$
	@addMass_1 *= #$@KIWI_SOLAR_MULTIPLIERS/ADVANCED/UPGRADE_MASS_MULTIPLIER$
	%chargeRate_1_Multiplier = #$@KIWI_SOLAR_MULTIPLIERS/ADVANCED/UPGRADE_CHARGERATE_MULTIPLIER$
	
	%addCost_2 = #$cost$
	@addCost_2 *= #$@KIWI_SOLAR_MULTIPLIERS/CONCENTRATING/UPGRADE_COST_MULTIPLIER$
	%addMass_2 = #$mass$
	@addMass_2 *= #$@KIWI_SOLAR_MULTIPLIERS/CONCENTRATING/UPGRADE_MASS_MULTIPLIER$
	%chargeRate_2_Multiplier = #$@KIWI_SOLAR_MULTIPLIERS/CONCENTRATING/UPGRADE_CHARGERATE_MULTIPLIER$
	
	%addCost_3 = #$cost$
	@addCost_3 *= #$@KIWI_SOLAR_MULTIPLIERS/EXPERIMENTAL/UPGRADE_COST_MULTIPLIER$
	%addMass_3 = #$mass$
	@addMass_3 *= #$@KIWI_SOLAR_MULTIPLIERS/EXPERIMENTAL/UPGRADE_MASS_MULTIPLIER$
	%chargeRate_3_Multiplier = #$@KIWI_SOLAR_MULTIPLIERS/EXPERIMENTAL/UPGRADE_CHARGERATE_MULTIPLIER$
	
	%baseChargeRate = #$MODULE[Module*SolarPanel],0/chargeRate$
	chargeRate_0 = #$baseChargeRate$
	@chargeRate_0 *= #$chargeRate_0_Multiplier$
	chargeRate_1 = #$baseChargeRate$
	@chargeRate_1 *= #$chargeRate_1_Multiplier$
	chargeRate_2 = #$baseChargeRate$
	@chargeRate_2 *= #$chargeRate_2_Multiplier$
	chargeRate_3 = #$baseChargeRate$
	@chargeRate_3 *= #$chargeRate_3_Multiplier$
	
	chargeRate_0_Description = #$chargeRate_0$
	@chargeRate_0_Description *= 10
	@chargeRate_0_Description ^= :\.\d+:: // Floor value to get an integer
	@chargeRate_0_Description /= 10
	
	chargeRate_1_Description = #$chargeRate_1$
	@chargeRate_1_Description *= 10
	@chargeRate_1_Description ^= :\.\d+:: // Floor value to get an integer
	@chargeRate_1_Description /= 10
	
	chargeRate_2_Description = #$chargeRate_2$
	@chargeRate_2_Description *= 10
	@chargeRate_2_Description ^= :\.\d+:: // Floor value to get an integer
	@chargeRate_2_Description /= 10
	
	chargeRate_3_Description = #$chargeRate_3$
	@chargeRate_3_Description *= 10
	@chargeRate_3_Description ^= :\.\d+:: // Floor value to get an integer
	@chargeRate_3_Description /= 10
	
	@MODULE[ModuleDeployableSolarPanel],*
	{
		!UPGRADES {} // No use having multple upgrades
	}
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = cellSwitch
		switcherDescription = #LOC_KTT_B9DESCRIPTION_CELLSWITCH // Cell Switch
		switcherDescriptionPlural = #LOC_KTT_B9DESCRIPTIONPLURALS_CELLSWITCH //Cell Types
		affectDragCubes = False
		affectFARVoxels = False

		SUBTYPE
		{
			name = Basic
			title = #LOC_KTT_B9DESCRIPTION_SOLAR_BASIC_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Electric Charge:</b> $../../chargeRate_0_Description$/sec
			primaryColor = #aebac0
			secondaryColor = #aebac0
			addedCost = #$../../addCost_0$
			addedMass = #$../../addMass_0$
			
			defaultSubtypePriority = 1
			
			MODULE
			{
				IDENTIFIER
				{
					name = ModuleDeployableSolarPanel
				}
				DATA 
				{
					chargeRate = #$../../../../chargeRate_0$
				}
			}
		}
		
		SUBTYPE
		{
			name = Advanced
			title = #LOC_KTT_B9DESCRIPTION_SOLAR_ADVANCED_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Electric Charge:</b> $../../chargeRate_1_Description$/sec
			primaryColor = #5d7682
			secondaryColor = #5d7682
			
			upgradeRequired = advancedSolarCell
			addedCost = #$../../addCost_1$
			addedMass = #$../../addMass_1$
			
			
			defaultSubtypePriority = 0
			
			MODULE
			{
				IDENTIFIER
				{
					name = ModuleDeployableSolarPanel
				}
				DATA 
				{
					chargeRate = #$../../../../chargeRate_1$
				}
			}
		}
		
		SUBTYPE
		{
			name = Concentrating
			title = #LOC_KTT_B9DESCRIPTION_SOLAR_CONCENTRATING_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Electric Charge:</b> $../../chargeRate_2_Description$/sec
			primaryColor = #2d373c
			secondaryColor = #2d373c
			
			upgradeRequired = concentratingSolarCell
			addedCost = #$../../addCost_2$
			addedMass = #$../../addMass_2$
			
			
			defaultSubtypePriority = 0

			MODULE
			{
				IDENTIFIER
				{
					name = ModuleDeployableSolarPanel
				}
				DATA 
				{
					chargeRate = #$../../../../chargeRate_2$
				}
			}
		}
		
		SUBTYPE
		{
			name = Experimental
			title = #LOC_KTT_B9DESCRIPTION_SOLAR_EXPERIMENTAL_TITLE
			descriptionSummary = 
			descriptionDetail = #<b>Electric Charge:</b> $../../chargeRate_3_Description$/sec
			primaryColor = #000000
			secondaryColor = #000000
			
			upgradeRequired = experimentalSolarCell
			addedCost = #$../../addCost_3$
			addedMass = #$../../addMass_3$
			
			
			defaultSubtypePriority = 0

			MODULE
			{
				IDENTIFIER
				{
					name = ModuleDeployableSolarPanel
				}
				DATA 
				{
					chargeRate = #$../../../../chargeRate_3$
				}
			}
		}
	}
}

PARTUPGRADE:NEEDS[Squad]
{
    type = solar
    name = advancedSolarCell
    partIcon = solarPanels4
    techRequired = improvedSolarTech
    entryCost = 100000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_SOLAR_ADVANCED // Advanced Solar Cell Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_SOLAR // Increased Charge Rate of Solar Panels
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_SOLAR // The imagineers have improved the charging rate of the solar panels.
}
PARTUPGRADE:NEEDS[Squad]
{
    type = solar
    name = concentratingSolarCell
    partIcon = solarPanels4
    techRequired = cuttingEdgeSolarTech
    entryCost = 300000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_SOLAR_CONCENTRATING // Concentrating Solar Cell Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_SOLAR // Increased Charge Rate of Solar Panels
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_SOLAR // The imagineers have improved the charging rate of the solar panels.
}
PARTUPGRADE:NEEDS[Squad]
{
    type = solar
    name = experimentalSolarCell
    partIcon = solarPanels4
    techRequired = quantumSolarTech
    entryCost = 900000
    cost = 0
    title = #LOC_KTT_PARTUPGRADE_TITLE_SOLAR_EXPERIMENTAL // Experimental Solar Cell Upgrade
    basicInfo = #LOC_KTT_PARTUPGRADE_BASICINFO_SOLAR // Increased Charge Rate of Solar Panels
    manufacturer = #LOC_KTT_PARTUPGRADE_MANUFACTURER // Kiwi Imagineers
    description = #LOC_KTT_PARTUPGRADE_DESCRIPTION_SOLAR // The imagineers have improved the charging rate of the solar panels.
}

@PART[*]:HAS[#kiwiSolarUpgradeType[standard],~solarUpgrade[off]]:FOR[zzzKiwiTechTree]
{
    %descriptionUpgrade = #LOC_KTT_PART_DESCRIPTION_SOLAR // The solar panels have upgrades in UPGRADENODE1, UPGRADENODE2, and UPGRADENODE3!
    @description = #$description$ \n\n<color=#ff0000>$descriptionUpgrade$</color>
    @description ^= :UPGRADENODE1:Improved Solar Tech (Tier 6):
	@description ^= :UPGRADENODE2:Cutting Edge Solar Tech (Tier 9):
	@description ^= :UPGRADENODE3:Quantum Solar Tech (Tier 12):
}
